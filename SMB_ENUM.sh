#!/bin/bash

# Port 139, 445: SMB
# --> https://0xdf.gitlab.io/2018/12/02/pwk-notes-smb-enumeration-checklist-update1.html

. ENV/general.env

FULL_PATH_DATA="${PWD}/${DATA_FOLDER}/$(basename $0)/"
mkdir -p "$FULL_PATH_DATA"

OUTPUT_FILE="${FULL_PATH_DATA}SMB_ENUM.txt"
rm $OUTPUT_FILE

# Enumerate hostname
echo "======== nmblookup : Enumerating Hostname ========" | tee -a $OUTPUT_FILE
nmblookup -A $IP | tee -a $OUTPUT_FILE
echo "" | tee -a $OUTPUT_FILE

# List shares
echo "======== smbmap : Listing Shares ========" | tee -a $OUTPUT_FILE
smbmap -H $IP | sed -n '/https:\/\/github.com\/ShawnDEvans\/smbmap/,$p' | sed '1,2d' | tee -a $OUTPUT_FILE
echo exit
echo "" | tee -a $OUTPUT_FILE

echo "======== smbclient : Listing Shares ========" | tee -a $OUTPUT_FILE
smbclient -L \\\\$IP | tee -a $OUTPUT_FILE
echo "" | tee -a $OUTPUT_FILE

echo "======== nmap : Listing Shares ========" | tee -a $OUTPUT_FILE
nmap --script smb-enum-shares -p 139,445 $IP | tee -a $OUTPUT_FILE
echo "" | tee -a $OUTPUT_FILE

# Check Null Sessions
echo "======== smbmap : Checking Null Sessions ========" | tee -a $OUTPUT_FILE
smbmap -H $IP | sed -n '/https:\/\/github.com\/ShawnDEvans\/smbmap/,$p' | sed '1,2d' | tee -a $OUTPUT_FILE
echo "" | tee -a $OUTPUT_FILE

echo "======== rpcclient : Checking Null Sessions ========" | tee -a $OUTPUT_FILE
rpcclient -U "" -N $IP | tee -a $OUTPUT_FILE
echo "" | tee -a $OUTPUT_FILE

echo "======== smbclient : Checking Null Sessions ========" | tee -a $OUTPUT_FILE
smbclient \\\\$IP\\[share name] | tee -a $OUTPUT_FILE
echo "" | tee -a $OUTPUT_FILE

# Check for vulnerabilities
echo "======== nmap : Checking for Vulnerabilities ========" | tee -a $OUTPUT_FILE
nmap --script smb-vuln* -p 139,445 $IP | tee -a $OUTPUT_FILE
echo "" | tee -a $OUTPUT_FILE

# Overall scan
echo "======== enum4linux : Performing Overall Scan ========" | tee -a $OUTPUT_FILE
enum4linux -a $IP | tee -a $OUTPUT_FILE
echo "" | tee -a $OUTPUT_FILE
